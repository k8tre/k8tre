# This GitHub Actions workflow validates the devcontainer.json and post-create.sh files
# Generated by Claude AI
name: DevContainer Validation

on:
  push:
    branches:
      - main
    paths:
      - ".devcontainer/**"
  pull_request:
    paths:
      - ".devcontainer/**"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate devcontainer.json
        run: |
          echo "Validating devcontainer.json format..."
          cat .devcontainer/devcontainer.json | jq empty || { echo "Invalid JSON in devcontainer.json"; exit 1; }
          echo "devcontainer.json is valid JSON"

          # Validate required fields
          echo "Checking required fields..."
          NAME=$(cat .devcontainer/devcontainer.json | jq -r '.name')
          if [ "$NAME" == "null" ] || [ -z "$NAME" ]; then
            echo "Missing 'name' field in devcontainer.json"
            exit 1
          fi
          echo "Required fields validation passed"

      - name: Validate post-create script
        run: |
          echo "Validating post-create.sh permissions..."
          if [ ! -f .devcontainer/post-create.sh ]; then
            echo "Missing post-create.sh file"
            exit 1
          fi

          echo "Validating post-create.sh syntax..."
          bash -n .devcontainer/post-create.sh || { echo "Syntax error in post-create.sh"; exit 1; }
          echo "post-create.sh is valid"

      - name: Validate used features
        run: |
          echo "Checking DevContainer features..."
          cat .devcontainer/devcontainer.json | jq -r '.features | keys[]' | while read feature; do
            echo "Validating feature: $feature"
            # Here we just check that the feature is properly formatted
            if [[ ! $feature =~ ^[a-zA-Z0-9-_\.\/]+:[a-zA-Z0-9-_\.\/]+$ ]]; then
              echo "Feature $feature is not properly formatted. Should be 'owner/repo:name'."
              exit 1
            fi
          done
          echo "All features are valid"
